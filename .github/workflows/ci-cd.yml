name: CI/CD

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ci:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'maven'

      - name: Maven Package (skip tests)
        run: mvn -B -ntp -DskipTests package

  docker:
    name: Build & Push Image to ACR
    needs: ci
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Aliyun ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push
        run: |
          set -e
          IMAGE="${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/goodface-interview:${{ github.sha }}"
          docker build -f interview-app/Dockerfile -t "$IMAGE" .
          docker push "$IMAGE"

  deploy-ecs:
    name: Deploy to ECS via SSH
    needs: docker
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify compose file exists
        run: |
          test -f deploy/docker-compose.yml && echo "compose file found" || (echo "compose file missing" && exit 1)

      - name: Copy docker-compose to ECS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          port: ${{ secrets.ECS_PORT }}
          key: ${{ secrets.ECS_SSH_KEY }}
          source: "deploy/docker-compose.yml"
          target: "/opt/goodface-interview/"
          strip_components: 1
          overwrite: true
          debug: true

      - name: Deploy on ECS
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          port: ${{ secrets.ECS_PORT }}
          key: ${{ secrets.ECS_SSH_KEY }}
          script: |
            set -e
            # 确保部署目录存在
            mkdir -p /opt/goodface-interview
            cd /opt/goodface-interview
            
            docker login ${{ secrets.ACR_REGISTRY }} -u '${{ secrets.ACR_USERNAME }}' -p '${{ secrets.ACR_PASSWORD }}'
            export ACR_REGISTRY='${{ secrets.ACR_REGISTRY }}'
            export ACR_NAMESPACE='${{ secrets.ACR_NAMESPACE }}'
            export IMAGE_TAG='${{ github.sha }}'
            # 由 GitHub Secrets 生成 .env（支持 INTERVIEW_* 前缀优先生效，缺失时回退到通用键）
            echo "ACR_REGISTRY=${{ secrets.ACR_REGISTRY }}" > .env
            echo "ACR_NAMESPACE=${{ secrets.ACR_NAMESPACE }}" >> .env
            echo "IMAGE_TAG=${{ github.sha }}" >> .env
            echo "SPRING_PROFILES_ACTIVE=prod" >> .env

            SPRING_DATASOURCE_URL_VAL='${{ secrets.INTERVIEW_SPRING_DATASOURCE_URL }}'
            [ -z "$SPRING_DATASOURCE_URL_VAL" ] && SPRING_DATASOURCE_URL_VAL='${{ secrets.SPRING_DATASOURCE_URL }}'
            SPRING_DATASOURCE_USERNAME_VAL='${{ secrets.INTERVIEW_SPRING_DATASOURCE_USERNAME }}'
            [ -z "$SPRING_DATASOURCE_USERNAME_VAL" ] && SPRING_DATASOURCE_USERNAME_VAL='${{ secrets.SPRING_DATASOURCE_USERNAME }}'
            SPRING_DATASOURCE_PASSWORD_VAL='${{ secrets.INTERVIEW_SPRING_DATASOURCE_PASSWORD }}'
            [ -z "$SPRING_DATASOURCE_PASSWORD_VAL" ] && SPRING_DATASOURCE_PASSWORD_VAL='${{ secrets.SPRING_DATASOURCE_PASSWORD }}'
            SPRING_REDIS_HOST_VAL='${{ secrets.INTERVIEW_SPRING_REDIS_HOST }}'
            [ -z "$SPRING_REDIS_HOST_VAL" ] && SPRING_REDIS_HOST_VAL='${{ secrets.SPRING_REDIS_HOST }}'
            SPRING_REDIS_PORT_VAL='${{ secrets.INTERVIEW_SPRING_REDIS_PORT }}'
            [ -z "$SPRING_REDIS_PORT_VAL" ] && SPRING_REDIS_PORT_VAL='${{ secrets.SPRING_REDIS_PORT }}'
            DUBBO_REGISTRY_ADDRESS_VAL='${{ secrets.INTERVIEW_DUBBO_REGISTRY_ADDRESS }}'
            [ -z "$DUBBO_REGISTRY_ADDRESS_VAL" ] && DUBBO_REGISTRY_ADDRESS_VAL='${{ secrets.DUBBO_REGISTRY_ADDRESS }}'
            DASHSCOPE_API_KEY_VAL='${{ secrets.INTERVIEW_DASHSCOPE_API_KEY }}'
            [ -z "$DASHSCOPE_API_KEY_VAL" ] && DASHSCOPE_API_KEY_VAL='${{ secrets.DASHSCOPE_API_KEY }}'

            echo "SPRING_DATASOURCE_URL=$SPRING_DATASOURCE_URL_VAL" >> .env
            echo "SPRING_DATASOURCE_USERNAME=$SPRING_DATASOURCE_USERNAME_VAL" >> .env
            echo "SPRING_DATASOURCE_PASSWORD=$SPRING_DATASOURCE_PASSWORD_VAL" >> .env
            echo "SPRING_REDIS_HOST=$SPRING_REDIS_HOST_VAL" >> .env
            echo "SPRING_REDIS_PORT=$SPRING_REDIS_PORT_VAL" >> .env
            echo "DUBBO_REGISTRY_ADDRESS=$DUBBO_REGISTRY_ADDRESS_VAL" >> .env
            echo "DASHSCOPE_API_KEY=$DASHSCOPE_API_KEY_VAL" >> .env
            
            # 检测 Docker Compose v2 是否安装
            if ! docker compose version >/dev/null 2>&1; then
              echo "Docker Compose v2 未安装或不可用，请安装 docker compose 插件"; exit 1;
            fi
            
            # 确认 Compose 文件存在
            if [ ! -f docker-compose.yml ] && [ ! -f docker-compose.yaml ] && [ ! -f compose.yml ] && [ ! -f compose.yaml ]; then
              echo "未找到 Compose 文件，请确保已上传 docker-compose.yml 到 /opt/goodface-interview";
              ls -la;
              exit 1;
            fi
            
            # 优先使用 docker-compose.yml
            COMPOSE_FILE=""
            for f in docker-compose.yml docker-compose.yaml compose.yml compose.yaml; do
              if [ -f "$f" ]; then COMPOSE_FILE="$f"; break; fi
            done
            echo "使用 Compose 文件: $COMPOSE_FILE"
            
            docker compose -f "$COMPOSE_FILE" --env-file .env pull
            docker compose -f "$COMPOSE_FILE" --env-file .env up -d --remove-orphans

            # Ensure unified network for name resolution across services (nacos/mysql/redis)
            docker network create goodface-net || true
            for svc in goodface-interview goodface-portal goodface-user mysql redis nacos; do
              docker network connect goodface-net "$svc" 2>/dev/null || true
            done
            echo "Unified network members:"
            docker network inspect goodface-net | sed -n '1,200p'